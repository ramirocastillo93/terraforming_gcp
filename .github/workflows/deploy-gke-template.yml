name: "Deploying GKE with Terraform"

on:
  workflow_call:
    inputs:
      deployment_directory:
        required: true
        type: string
      env:
        required: true
        type: string
    secrets:
      google_credentials:
        required: true

jobs:
  terraform-init-validate-plan-build:
    name: "Terraform"
    runs-on: ubuntu-latest
    # environment: ${{ input.gh_env }}
    env: 
      GOOGLE_CREDENTIALS: ${{ secrets.google_credentials }}
    defaults:
      run:
        working-directory: ${{ inputs.deployment_directory }}
    steps:
      # This step will allow the workflow to use a copy of the repository's code.
      - name: Checkout
        uses: actions/checkout@v2

      # This step will install all the TF dependencies in order to properly run this workflow.
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1

      - name: TF Init
        run: terraform init

      - name: TF FMT
        run: terraform fmt -recursive -check 

      - name: TF Plan 
        run: terraform plan -var-file={{ inputs.env }}.tfvars -out=${{ inputs.env }}.tfplan -lock=false
      
      - name: TF Apply 
        run: terraform apply -auto-approve ${{ inputs.env }}}.tfplan